name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

jobs:
  # 代码质量检查
  lint:
    name: 代码质量检查
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 安装依赖
        run: npm ci
      
      - name: 类型检查
        run: npm run build:check
        continue-on-error: true

  # E2E 测试
  test-e2e:
    name: E2E 测试
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 安装依赖
        run: npm ci
      
      - name: 安装 Playwright 浏览器
        run: npx playwright install --with-deps chromium
      
      - name: 运行 E2E 测试
        run: npm run test:e2e
      
      - name: 上传测试报告
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
      
      - name: 上传测试结果
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 30

  # Web 版本构建
  build-web:
    name: 构建 Web 版本
    runs-on: ubuntu-latest
    needs: [lint, test-e2e]
    steps:
      - uses: actions/checkout@v4
      
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 安装依赖
        run: npm ci
      
      - name: 构建
        run: npm run build
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: dist/
          retention-days: 7

  # Electron 桌面版构建（Windows）
  build-electron-windows:
    name: 构建 Electron (Windows)
    runs-on: windows-latest
    needs: [lint, test-e2e]
    steps:
      - uses: actions/checkout@v4
      
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 安装依赖
        run: npm ci
      
      - name: 构建 Electron
        run: npm run build:dir
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: electron-windows
          path: dist-electron/
          retention-days: 7

  # Electron 桌面版构建（macOS）
  build-electron-macos:
    name: 构建 Electron (macOS)
    runs-on: macos-latest
    needs: [lint, test-e2e]
    steps:
      - uses: actions/checkout@v4
      
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 安装依赖
        run: npm ci
      
      - name: 构建 Electron
        run: npm run build:dir
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: electron-macos
          path: dist-electron/
          retention-days: 7

  # Electron 桌面版构建（Linux）
  build-electron-linux:
    name: 构建 Electron (Linux)
    runs-on: ubuntu-latest
    needs: [lint, test-e2e]
    steps:
      - uses: actions/checkout@v4
      
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 安装依赖
        run: npm ci
      
      - name: 构建 Electron
        run: npm run build:dir
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: electron-linux
          path: dist-electron/
          retention-days: 7

