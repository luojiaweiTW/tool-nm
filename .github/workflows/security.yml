name: å®‰å…¨æ‰«æ

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨ 2 ç‚¹è¿è¡Œ
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  # ä¾èµ–æ¼æ´æ‰«æ
  dependency-check:
    name: ä¾èµ–æ¼æ´æ‰«æ
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: è¿è¡Œ npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: ç”Ÿæˆå®¡è®¡æŠ¥å‘Š
        run: npm audit --json > audit-report.json
        continue-on-error: true
      
      - name: ä¸Šä¼ å®¡è®¡æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-report
          path: audit-report.json
          retention-days: 30

  # CodeQL ä»£ç å®‰å…¨åˆ†æ
  codeql:
    name: CodeQL å®‰å…¨åˆ†æ
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript', 'typescript' ]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: åˆå§‹åŒ– CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      
      - name: è‡ªåŠ¨æ„å»º
        uses: github/codeql-action/autobuild@v3
      
      - name: æ‰§è¡Œ CodeQL åˆ†æ
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  # ä¾›åº”é“¾å®‰å…¨åˆ†æï¼ˆå¯é€‰ï¼Œéœ€è¦é›†æˆ Socket æˆ– Snykï¼‰
  supply-chain:
    name: ä¾›åº”é“¾å®‰å…¨åˆ†æ
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: æ£€æŸ¥ package-lock.json
        run: |
          if [ -f package-lock.json ]; then
            echo "âœ… package-lock.json å­˜åœ¨"
          else
            echo "âŒ package-lock.json ä¸å­˜åœ¨ï¼Œå»ºè®®è¿è¡Œ npm install"
            exit 1
          fi
      
      - name: æ£€æŸ¥å¯ç–‘ä¾èµ–
        run: |
          echo "ğŸ“¦ æ£€æŸ¥å·²å®‰è£…çš„ä¾èµ–åŒ…..."
          npm list --depth=0 || true
          
          echo ""
          echo "âš ï¸ æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–..."
          npm outdated || true
      
      # å¦‚æœå¯ç”¨äº† Snykï¼Œå–æ¶ˆæ³¨é‡Šä»¥ä¸‹æ­¥éª¤
      # - name: Run Snyk å®‰å…¨æ‰«æ
      #   uses: snyk/actions/node@master
      #   env:
      #     SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      #   with:
      #     args: --severity-threshold=high

